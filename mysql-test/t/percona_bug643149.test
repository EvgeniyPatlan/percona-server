--source include/have_profiling.inc

SET @old_slow_query_log_file=@@global.slow_query_log_file;
SET GLOBAL slow_query_log=on;
SET LOCAL log_slow_verbosity='profiling';
SET LOCAL long_query_time=0;

let slogfile=$MYSQLTEST_VARDIR/percona_bug643149_slow.log;
--replace_result $MYSQLTEST_VARDIR MYSQLTEST_VARDIR
--eval SET GLOBAL slow_query_log_file='$slogfile';

SELECT 1;

# restoring "slow_query_log_file" global variable here (in the
# same connection) also guarantees that the previous statement
# "SELECT 1" has 100% completed (including all writing to the
# slow query log)
SET GLOBAL slow_query_log_file=@old_slow_query_log_file;

--let $file_being_created= $slogfile
--source include/wait_for_file_to_be_created.inc

perl;
  $slogfile= $ENV{'slogfile'};

  open(FILE, "$slogfile") or
    die("Unable to read slow query log file $slogfile: $!\n");
  while(<FILE>) {
    next if (!/^#/);
    next if (/^# Time:/);
    s/: +[0-9]+/: X/g;
    s/[0-9]+/X/g;
    print;
  }

  close(FILE);
EOF

--remove_file $slogfile
