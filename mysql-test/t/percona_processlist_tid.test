--source include/linux.inc
--source include/not_embedded.inc

# creating several connections in order to have more than one record in the processlist
--connect (connection_one,localhost,root,,)
--connect (connection_two,localhost,root,,)
--connect (connection_three,localhost,root,,)

--connection default

--disable_query_log

# creating a table to store current process id
CREATE TABLE pid_table(pid_no INT);

# creating a table to store LWP ids of the current process
CREATE TABLE lwp_table(lwp_no INT);

# extracting current process id from the @@pid_file
--let $pid_file=`SELECT @@pid_file`
--eval LOAD DATA LOCAL INFILE '$pid_file' INTO TABLE pid_table
--let $mysqld_pid = `SELECT pid_no FROM pid_table`

# filling lwp_table with values returned from "ps" system call
# "--no-header" means omitting column names in output (just plain numbers)
# "-L" means include lightweight threads
# "-p $mysqld_pid" means only output LWPs which belolng to the specified process id
# "-o lwp" means output only LWP id
--let $ps_result_file=$MYSQLTEST_VARDIR/percona_ps_result
--exec ps --no-headers -L -p $mysqld_pid -o lwp > $ps_result_file
--eval LOAD DATA LOCAL INFILE '$ps_result_file' INTO TABLE lwp_table

--enable_query_log

# checking that all Tids from the current connections can be found in the "ps" list
# the result of this query is expected to be 0
SELECT COUNT(*) FROM information_schema.processlist WHERE tid NOT IN (SELECT lwp_no FROM lwp_table);

--disable_query_log

# temporary table cleanup
DROP TABLE pid_table, lwp_table;

--enable_query_log

# dropping auxiliary connections
--disconnect connection_one
--disconnect connection_two
--disconnect connection_three

# removing temporary file generated by system "ps" call
--remove_file $ps_result_file
