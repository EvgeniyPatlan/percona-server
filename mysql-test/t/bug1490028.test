#
# bug lp:bug1490028 slow_query_log_always_write_time doesn't work
#
--source include/have_innodb.inc

CREATE TABLE t1(a INT) ENGINE=innodb;
INSERT INTO t1 VALUES (1), (2), (3);

SET @slow_query_log_always_write_time_save = @@slow_query_log_always_write_time;
SET @log_slow_rate_limit_save = @@log_slow_rate_limit;
SET @log_slow_rate_type_save = @@log_slow_rate_type;

SET GLOBAL slow_query_log_always_write_time = 10;
SET GLOBAL log_slow_rate_limit = 10;
SET GLOBAL log_slow_rate_type = 'query';

connect (auxcon,localhost,root,,);

--echo Connection Aux
connection auxcon;
LOCK TABLES t1 WRITE;

--echo Connection Default
connection default;
--let log_file=percona_bug1490028
--source include/log_start.inc
--send SELECT * FROM t1

--echo Connection Aux
connection auxcon;
SELECT SLEEP(11);
UNLOCK TABLES;

--echo Connection Default
connection default;
--reap

--source include/log_stop.inc
--let grep_pattern = ^SELECT \* FROM t1;\$
--source include/log_grep.inc

disconnect auxcon;

SET GLOBAL slow_query_log_always_write_time = @slow_query_log_always_write_time_save;
SET GLOBAL log_slow_rate_limit = @log_slow_rate_limit_save;
SET GLOBAL log_slow_rate_type = @log_slow_rate_type_save;

DROP TABLE t1;

--source include/log_cleanup.inc
